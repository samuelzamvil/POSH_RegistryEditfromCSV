This is a script I wrote back in september, I may or may not revist this in the future. It's currently working and I use it in an MDT task sequence and in audit mode while I am prepping an OS for sysprep and capture.

If I do come back to this, I will probably want to set this up as a cmdlet and allow for pipeline input.
